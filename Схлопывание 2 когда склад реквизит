
Процедура ОбработкаПроведения(Отказ, Режим)
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПродажаТовараСписокТоваров.Товар КАК Товар,
	|	ПродажаТовараСписокТоваров.Ссылка.Склад КАК Склад,
	|	СУММА(ПродажаТовараСписокТоваров.Количество) КАК Количество
	|ИЗ
	|	Документ.ПродажаТовара.СписокТоваров КАК ПродажаТовараСписокТоваров
	|ГДЕ
	|	ПродажаТовараСписокТоваров.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	ПродажаТовараСписокТоваров.Товар,
	|	ПродажаТовараСписокТоваров.Ссылка.Склад";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Движение = Движения.ОстаткиТоваровНаСкладах.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;
		Движение.Товар = Выборка.Товар;
		Движение.Склад = Выборка.Склад;
		Движение.Количество = Выборка.Количество;
	КонецЦикла;
	
	Движения.ОстаткиТоваровНаСкладах.Записывать = Истина;

	Движения.Записать();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОстаткиТоваровНаСкладахОстатки.Товар,
	|	ОстаткиТоваровНаСкладахОстатки.КоличествоОстаток
	|ИЗ
	|	РегистрНакопления.ОстаткиТоваровНаСкладах.Остатки(
	|			,
	|			Склад = &Склад
	|				И Товар В (&МассивТоваров)) КАК ОстаткиТоваровНаСкладахОстатки
	|ГДЕ
	|	ОстаткиТоваровНаСкладахОстатки.КоличествоОстаток < 0";
	
	Запрос.УстановитьПараметр("Дата", Новый Граница(МоментВремени(), ВидГраницы.Включая));
	Запрос.УстановитьПараметр("Склад", Склад);
	Запрос.УстановитьПараметр("МассивТоваров", СписокТоваров.ВыгрузитьКолонку("Товар"));
	
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Отказ = Истина;
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			Сообщить("На складе " + Склад +
			" не хватает " + ВыборкаДетальныеЗаписи.КоличествоОстаток*(-1) + " шт. товаров " + ВыборкаДетальныеЗаписи.Товар);	
		КонецЦикла;		
	КонецЕсли;
	
	
КонецПроцедуры
